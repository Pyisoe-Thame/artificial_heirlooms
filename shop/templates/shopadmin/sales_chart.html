<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sales Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div id="chart-container" data-url="{% url 'shop_admin:get_sales_data' 'interval_placeholder' %}" style="width: 900px; height: 600px;">
        <h2>Sales Statistics</h2>
        <label for="interval">Choose Interval:</label>
        <select id="interval">
            <option value="week">Week</option>
            <option value="month">Month</option>
            <option value="year">Year</option>
        </select>
        
        <canvas id="salesChart"></canvas>
    </div>    

<script>
    const ctx = document.getElementById('salesChart').getContext('2d');
    let salesChart;

    // Initialize chart
    function initializeChart(labels, data) {

        // Sort labels based on the 'sortable' date format
        const sortedData = labels.map(item => ({ label: item.label, sortable: item.sortable, value: data[labels.indexOf(item)] }))
            .sort((a, b) => new Date(a.sortable) - new Date(b.sortable));

        const sortedLabels = sortedData.map(item => item.label);
        const sortedValues = sortedData.map(item => item.value);

        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedLabels,
                datasets: [{
                    label: 'Sales',
                    data: sortedValues,
                    backgroundColor: 'rgba(0, 99, 132, 0.6)',
                    borderColor: 'rgba(0, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                // maintainAspectRatio: false,  // allows custom dimensions
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Fetch data for the selected interval
    function updateChart(interval) {
        // Get the base URL from the data attribute
        const urlTemplate = document.getElementById('chart-container').dataset.url;
        // Replace 'interval_placeholder' with the actual interval
        const url = urlTemplate.replace('interval_placeholder', interval);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                initializeChart(data.labels, data.data);
            });
    }

    // update chart when interval changes
    document.getElementById('interval').addEventListener('change', function() {
        updateChart(this.value);
    });

    // ensure the dropdown defaults to "week" on page load and browser refreshes
    document.addEventListener("DOMContentLoaded", function() {
        const intervalSelect = document.getElementById('interval');
        
        // set default value to 'week' on page load (just in case it's not selected)
        intervalSelect.value = 'week';
        
        // load chart with 'week' data initially
        updateChart('week');
    });
</script>

</body>
</html>

